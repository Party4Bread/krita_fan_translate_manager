This part from copied from https://github.com/Acly/krita-ai-diffusion.
Bit edited for removing unused features.